% Lua以外への対応がまだ。\zw未定義問題と、縦書きかどうかの判定。

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{modernruler}[2025/12/28, Version 1.0.0]

%%% basical settings
\RequirePackage{kvoptions} 
\RequirePackage{varwidth}
\RequirePackage[most]{tcolorbox}

%%% kv（undernoteの方）
\SetupKeyvalOptions{%
  family=undernote,%
  prefix=undernote@%
}
\DeclareStringOption[\footnotesize]{notesize}
\DeclareStringOption[3mm]{notepos}
\DeclareStringOption[4mm]{noteshift}
\DeclareStringOption[.4pt]{noterulethickness}
\DeclareStringOption[1.5mm]{noterulehshift}
\DeclareStringOption[1.5mm]{noterulehsize}
\DeclareStringOption[2em]{notesep}
\DeclareStringOption[3em]{noteoverhang}
\DeclareStringOption[0]{parstyle}
\ProcessKeyvalOptions*

\def\notesize{\undernote@notesize}                    %%% 注釈部分の文字サイズ
\def\notepos{\undernote@notepos}                      %%% 注釈へと伸ばす縦線の長さの最小値
\def\noteshift{\undernote@noteshift}                  %%% 注釈を下にずらす場合の1段階分の移動量
\def\noterulethickness{\undernote@noterulethickness}  %%% \note で用いる罫線の太さ
\def\noterulehshift{\undernote@noterulehshift}        %%% 注釈へと伸ばす縦線の位置（注釈をつける語句につけた下線の左端から
                                                      %%% \noterulehshift だけ右にずれた位置に縦線を置く）
\def\noterulehsize{\undernote@noterulehsize}          %%% 注釈へと伸ばす横線の長さ
\def\notesep{\undernote@notesep}                      %%% 前にある注釈が次の注釈の縦線から \notesep 以内に近づくようなら，
                                                      %%% 前にある注釈を下にずらす（「2em」のように文字サイズに依存する
                                                      %%% 指定をした場合は，\notesize（の，現在使用中のフォント）における値）
\def\noteoverhang{\undernote@noteoverhang}            %%% parbox に入れるタイプ（スターをつけた時）
                                                      %%% どの程度後ろに注釈部分を張り出させるか
\def\noteparstyle{\undernote@parstyle}                %%% 注釈部分を
                                                      %%% 1 と 2 以外: 囲みなし 1: 実線で囲う 2:点線で囲う


% command
\NewDocumentCommand{\SetUNoteSize}{O{\footnotesize}}{%
  \def\notesize{#1}%
}                 
\NewDocumentCommand{\SetUNoteRuleThickness}{O{.4pt}}{%
  \def\noterulethickness{#1}%
}
\NewDocumentCommand{\SetUNoteRuleHShift}{O{1.5mm}}{%
  \def\noterulehshift{#1}%
}
\NewDocumentCommand{\SetUNoteRuleHSize}{O{1.5mm}}{%
  \def\noterulehsize{#1}%
}
\NewDocumentCommand{\SetUNotePos}{O{3mm}}{%
  \def\notepos{#1}%
}
\NewDocumentCommand{\SetUNoteShift}{O{4mm}}{%
  \def\noteshift{#1}%
}
\NewDocumentCommand{\SetUNoteSep}{O{2em}}{%
  \def\notesep{#1}%
}
\NewDocumentCommand{\SetUNoteOverHang}{O{3em}}{%
  \def\noteoverhang{#1}%
}
\NewDocumentCommand{\SetUNoteParstyle}{O{0}}{%
  \ifnum#1=1%
   \let\wrap@undernote\wrap@undernote@styleA%
   \let\wrap@undernote@par\wrap@undernote@par@styleA%
   \def\hline@undernote@par{\mruleh[height=\noterulethickness, width=\undernote@textlen@tempo]}%
   \def\vlines@undernote@par{%
      \mrulev[height=\dimen@, width=\noterulethickness, depth=0pt]%
      \mruleh[height=\noterulethickness, width=\noterulehsize, depth=0pt, 
      dash=true, dash-len=.01pt, gap-len=0pt]%
   }%
   \else\ifnum#1=2
      \let\wrap@undernote\wrap@undernote@styleB%
      \let\wrap@undernote@par\wrap@undernote@par@styleB%
      \def\hline@undernote@par{\mruleh[height=\noterulethickness, width=\undernote@textlen@tempo, dash=true]}%
         %%% dash=true, dash-len=.01pt, gap-len=0pt
         %%% としている理由は、呼び出しがvmode内部であるため、
         %%% 内部的に\vruleを使わせるという技術的意図。
      \def\vlines@undernote@par{%
         \mrulev[height=\dimen@, width=\noterulethickness, depth=0pt ,dash=true]%
         \mruleh[height=\noterulethickness, width=\noterulehsize, depth=0pt, dash=true]%
      }%
      \else
         \let\wrap@undernote\wrap@undernote@styleC%
         \let\wrap@undernote@par\wrap@undernote@par@styleC%
         \def\hline@undernote@par{\mruleh[height=\noterulethickness, width=\undernote@textlen@tempo]}%
         \def\vlines@undernote@par{%
            \mrulev[height=\dimen@, width=\noterulethickness, depth=0pt]%
            \mruleh[height=\noterulethickness, width=\noterulehsize, depth=0pt,
            dash=true, dash-len=.01pt, gap-len=0pt]%
         }%
   \fi\fi
}
%%%

%%% modern rule commands
\ExplSyntaxOn

% 変数の宣言
\dim_new:N  \l_mrule_width_dim
\dim_new:N  \l_mrule_height_dim
\dim_new:N  \l_mrule_depth_dim
\dim_new:N  \l_mrule_dash_len_dim
\dim_new:N  \l_mrule_gap_len_dim
\dim_new:N  \l_mrule_total_width_dim % 計算用
\tl_new:N   \l_mrule_color_tl
\bool_new:N \l_mrule_dash_bool

% キーの定義
\keys_define:nn { modernrule }
  {
    width    .dim_set:N = \l_mrule_width_dim,
    height   .dim_set:N = \l_mrule_height_dim,
    depth    .dim_set:N = \l_mrule_depth_dim,
    color    .tl_set:N  = \l_mrule_color_tl,
    dash     .bool_set:N = \l_mrule_dash_bool,
    dash-len .dim_set:N  = \l_mrule_dash_len_dim,
    gap-len  .dim_set:N  = \l_mrule_gap_len_dim,

    % デフォルト値
    width    .initial:n = 0pt,
    height   .initial:n = 0pt,
    depth    .initial:n = 0pt,
    color    .initial:n = black,
    dash     .initial:n = false,
    dash-len .initial:n = 2pt,
    gap-len  .initial:n = 2pt,
  }

% 水平モード用 (テキスト中の垂直棒)
\NewDocumentCommand{\mrulev}{O{}}
  {
    \group_begin:
    \keys_set:nn { modernrule } { #1 }
    \dim_compare:nNnTF { \l_mrule_width_dim } > { 0pt } {
    \color{\l_mrule_color_tl}
    \bool_if:NTF \l_mrule_dash_bool
      {\ifvmode \nointerlineskip \fi%
      \dim_set:Nn \l_tmpa_dim { \l_mrule_height_dim + \l_mrule_depth_dim }
      \vbox_to_ht:nn { \l_mrule_height_dim + \l_mrule_depth_dim }
         {%
            \dim_compare:nNnTF { \l_tmpa_dim } < { \l_mrule_dash_len_dim }
            { % A. 短すぎる時はただの棒
               \hrule width \l_mrule_width_dim height \l_mrule_height_dim depth \l_mrule_depth_dim
            }{ % B. 通常の破線ロジック
               \hrule width \l_mrule_width_dim height \l_mrule_dash_len_dim
               \xleaders \vbox:n 
               {% 注意！こっちは \hrule
                     \skip_vertical:N \l_mrule_gap_len_dim
                     \hrule width \l_mrule_width_dim height \l_mrule_dash_len_dim
               }\vfill%
         }}\ifvmode \nointerlineskip \fi%
      }
      {% 注意！こっちは \vrule
         \ifvmode \nointerlineskip \fi%
         \noindent\vrule width \l_mrule_width_dim height \l_mrule_height_dim depth \l_mrule_depth_dim
         \ifvmode \nointerlineskip \fi%
      }
    }{%
      \ifvmode \nointerlineskip \fi%
      \noindent\vrule width \l_mrule_width_dim height \l_mrule_height_dim depth \l_mrule_depth_dim
      \ifvmode \nointerlineskip \fi%
    }
    \group_end:
  }

% 垂直モード用 (段落間の水平線)
\NewDocumentCommand{\mruleh}{O{}}
  {
    \group_begin:
    \keys_set:nn { modernrule } { #1 }
    \dim_compare:nNnTF { \l_mrule_width_dim } > { 0pt } {
    \color{\l_mrule_color_tl}
    
    % 幅の計算ロジックを修正
    \dim_compare:nNnTF { \l_mrule_width_dim } = { 0pt }
      { \dim_set:Nn \l_mrule_total_width_dim { \linewidth } }
      { \dim_set:Nn \l_mrule_total_width_dim { \l_mrule_width_dim } }
    
    \bool_if:NTF \l_mrule_dash_bool
      {\ifvmode \nointerlineskip \fi%
         \hbox_to_wd:nn { \l_mrule_total_width_dim }
            {%
            \dim_compare:nNnTF { \l_mrule_total_width_dim } < { \l_mrule_dash_len_dim } {
               % A. 短すぎる時はただの棒
               \noindent\vrule width \l_mrule_total_width_dim height \l_mrule_height_dim depth \l_mrule_depth_dim
            }{ % B. 通常の破線ロジック
               \noindent\vrule width \l_mrule_dash_len_dim height \l_mrule_height_dim depth \l_mrule_depth_dim
               \xleaders \hbox:n 
               {% 注意！こっちは \vrule
                     \skip_horizontal:N \l_mrule_gap_len_dim
                     \vrule width \l_mrule_dash_len_dim height \l_mrule_height_dim depth \l_mrule_depth_dim
               }\hfill%
            }
         }\ifvmode \nointerlineskip \fi%
      }
      {% 注意！こっちは \hrule
         \ifvmode \nointerlineskip \fi%
         \hrule width \l_mrule_total_width_dim height \l_mrule_height_dim depth \l_mrule_depth_dim
         \ifvmode \nointerlineskip \fi%
      }
    }{\ifvmode \nointerlineskip \fi%
      \hrule width \l_mrule_total_width_dim height \l_mrule_height_dim depth \l_mrule_depth_dim
      \ifvmode \nointerlineskip \fi%
    }
    \group_end:
  }

\ExplSyntaxOff
%%%

\DeclareTotalTCBox{\FramedBox@undernote}{ O{} +m }{%
  on line,arc=0pt,
  sharp corners,boxsep=0mm,
  left=.3mm,right=.3mm,top=0.3mm,bottom=0.3mm,
  colback=white,colframe=white,
  enhanced,before={\hspace*{-.4ex}},
  borderline={\noterulethickness}{0mm}{solid},
  #1
}{#2}
\DeclareTotalTCBox{\DashedBox@undernote}{ O{} +m }{%
  on line,arc=0pt,
  sharp corners,boxsep=0mm,
  left=.3mm,right=.3mm,top=0.3mm,bottom=0.3mm,
  colback=white,colframe=white,
  enhanced,before={\hspace*{-.4ex}},
  borderline={\noterulethickness}{0mm}{dashed},
  #1
}{#2}
\DeclareTotalTCBox{\NoframeBox@undernote}{ O{} +m }{%
  on line,arc=0pt,
  sharp corners,boxsep=0mm,
  left=.3mm,right=.3mm,top=0.3mm,bottom=0.3mm,
  colback=white,colframe=white,
  enhanced,before={\hspace*{-.4ex}},
  #1
}{#2}

\newlength{\undernote@textlen@tempo}

\NewDocumentCommand{\wrap@undernote@par@styleA}{ +m }{%
{%
   \FramedBox@undernote{%
      \parbox[t]{\dimexpr\undernote@textlen@tempo - \noterulehsize - \noterulehshift + \noteoverhang\relax}%
      {\setlength{\baselineskip}{.5ex}\setlength{\parindent}{1em}#1}}%
}}
\NewDocumentCommand{\wrap@undernote@par@styleB}{ +m }{%
{%
   \DashedBox@undernote{%
      \parbox[t]{\dimexpr\undernote@textlen@tempo - \noterulehsize - \noterulehshift + \noteoverhang\relax}%
      {\setlength{\baselineskip}{.5ex}\setlength{\parindent}{1em}#1}}%
}}
\NewDocumentCommand{\wrap@undernote@par@styleC}{ +m }{%
{%
   \NoframeBox@undernote{%
      \parbox[t]{\dimexpr\undernote@textlen@tempo - \noterulehsize - \noterulehshift + \noteoverhang\relax}%
      {\setlength{\baselineskip}{.5ex}\setlength{\parindent}{1em}#1}}%
}}
\NewDocumentCommand{\wrap@undernote@styleA}{ +m }{{\FramedBox@undernote{#1}}}
\NewDocumentCommand{\wrap@undernote@styleB}{ +m }{{\DashedBox@undernote{#1}}}
\NewDocumentCommand{\wrap@undernote@styleC}{ +m }{{\NoframeBox@undernote{#1}}}
\NewDocumentCommand{\wrap@undernote}{ +m }{{#1}}
\NewDocumentCommand{\wrap@undernote@par}{ +m }{{\wrap@undernote@styleC{#1}}}
\ifnum\noteparstyle=1
   \let\wrap@undernote\wrap@undernote@styleA
   \let\wrap@undernote@par\wrap@undernote@par@styleA
   \def\hline@undernote@par{\mruleh[height=\noterulethickness, width=\undernote@textlen@tempo]}%
   \def\vlines@undernote@par{%
   %%% dash=true, dash-len=.01pt, gap-len=0pt
   %%% としている理由は、呼び出しがvmode内部であるため、
   %%% 内部的に\vruleを使わせるという技術的意図。
      \mrulev[height=\dimen@, width=\noterulethickness, depth=0pt]%
      \mruleh[height=\noterulethickness, width=\noterulehsize, depth=0pt, 
      dash=true, dash-len=.01pt, gap-len=0pt]%
   }
\else\ifnum\noteparstyle=2
   \let\wrap@undernote\wrap@undernote@styleB
   \let\wrap@undernote@par\wrap@undernote@par@styleB
   \def\hline@undernote@par{\mruleh[height=\noterulethickness, width=\undernote@textlen@tempo, dash=true]}%
   \def\vlines@undernote@par{%
      \mrulev[height=\dimen@, width=\noterulethickness, depth=0pt ,dash=true]%
      \mruleh[height=\noterulethickness, width=\noterulehsize, depth=0pt, dash=true]%
   }
   \else
      \let\wrap@undernote\wrap@undernote@styleC
      \let\wrap@undernote@par\wrap@undernote@par@styleC
      \def\hline@undernote@par{\mruleh[height=\noterulethickness, width=\undernote@textlen@tempo]}%
      \def\vlines@undernote@par{%
         \mrulev[height=\dimen@, width=\noterulethickness, depth=0pt]%
         \mruleh[height=\noterulethickness, width=\noterulehsize, depth=0pt,
         dash=true, dash-len=.01pt, gap-len=0pt]%
      }
\fi\fi

\newbox\@note@maintext
\newbox\@note@subtext
\newcounter{undernote@id} \setcounter{undernote@id}{0}
\DeclareDocumentCommand{\undernote}{ s O{} m +m O{} }{%
      %%% #1（star）注釈をparboxに包む
      %%% #2 (optinal): 注釈を下にずらす「行数」（与えない場合自動設定）
      %%% #3: 注釈をつける語句
      %%% #4: 注釈
      %%% #5: どういう線にするか
   \def\key@undernote@ruler{#5}%
   \settowidth{\undernote@textlen@tempo}{#3}%
   \begingroup%
   \stepcounter{undernote@id}%
   \ifmmode%
      \@note@save@conters%
      \savepos%
      \expandafter\@math@note%
   \else%
      \leavevmode%
      \savepos%
      \expandafter\@text@note%
   \fi%
   {#2}{#3}{%
      \ifnum\ltjgetparameter{direction}=4%
         \begin{varwidth}[t]{\maxdimen}%
            \IfBooleanTF{#1}{\wrap@undernote@par{#4}}{\wrap@undernote{#4}}%
         \end{varwidth}%
     \else%
         \raisebox{.38\zw}{%
            \begin{varwidth}[t]{\maxdimen}%
               \IfBooleanTF{#1}{\wrap@undernote@par{#4}}{\wrap@undernote{#4}}%
            \end{varwidth}%
         }%
     \fi%
     }%
   \endgroup}

% 名称カウンタ
\def\@note@save@conters{%
   \begingroup
   \def\@elt@udnote##1{%
      \expandafter\ifx\csname c@##1\endcsname\c@page\else
         \csname c@##1\endcsname\the\csname c@##1\endcsname\relax
      \fi}%
   \edef\@tempa{\cl@@ckpt}%
   \expandafter\endgroup
   \expandafter\def\expandafter\@note@restore@counters\expandafter{\@tempa}}

% 数式モードの場合への対応
\def\@math@note#1#2#3{%
   \mathchoice
      {\@note@restore@counters\@text@note{#1}{\m@th$\displaystyle #2$}{#3}}%
      {\@note@restore@counters\@text@note{#1}{\m@th$\textstyle #2$}{#3}}%
      {\@note@restore@counters\@text@note{#1}{\m@th$\scriptstyle #2$}{#3}}%
      {\@note@restore@counters\@text@note{#1}{\m@th$\scriptscriptstyle #2$}{#3}}}

% 注釈の内部実装
\long\def\@text@note#1#2#3{%
   \hbox{%
      \def\@ND@vsize{#1}%
      \ifx\@ND@vsize\@empty%
         \expandafter\ifx\csname @NDS@\the\c@undernote@id\endcsname\relax%
            \def\@ND@vsize{1}%
         \else%
            \edef\@ND@vsize{\csname @NDS@\the\c@undernote@id\endcsname}%
         \fi%
      \fi%
      \setbox\@note@maintext\hbox{#2\vphantom{)}}%
      \setbox\@note@subtext\hbox{\notesize #3}%
      \vtop{%
         \box\@note@maintext%
         \begingroup%
         \notesize%
         \if@filesw%
            \dimen@\wd\@note@subtext%
            \advance\dimen@\notesep\relax%
            \edef\@tempa{%
               \write\@auxout{%
                  \string\notedata{\the\c@undernote@id}%
                     {\noexpand\the\lastxpos}{\noexpand\the\lastypos}%
                     {\number\dimen@}{\number\ht\@note@subtext}{\number\dp\@note@subtext}%
                     {\noexpand\the\c@page}}}%
            \@tempa%
         \else
            \write16{}%
         \fi
         \endgroup%
         \vskip\p@%
         %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
         % ベース
         % \hrule \@height\noterulethickness%
         % モダン
         % \mruleh[height=\noterulethickness, width=\undernote@textlen@tempo ,dash=true]%
         %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
         \hline@undernote@par%
         \hbox{\notesize%
            \hskip\noterulehshift%
            \count@\@ND@vsize\relax \advance\count@\m@ne%
            \dimen@\noteshift\relax \multiply\dimen@\count@%
            \advance\dimen@\notepos\relax%
            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
            % ベース
            % \vrule \@height\dimen@ \@width\noterulethickness \@depth\z@%
            % \vrule \@height\noterulethickness \@width\noterulehsize \@depth\z@%
            % モダン
            % \mrulev[height=\dimen@, width=\noterulethickness, depth=0pt ,dash=true]%
            % \mruleh[height=\noterulethickness, width=\noterulehsize, depth=0pt, dash=true]%
            %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
            \vlines@undernote@par%
            \hskip\p@%
            \hbox to\z@{\lower.38\zw\box\@note@subtext\hss}}}}}

\newcount\@ND@min
\newcount\@ND@max
\global\@ND@max -\@M
\global\let\@ND@idlist\@empty
\let\@ND@elt\relax
\def\notedata#1#2#3#4#5#6#7{%%% #1: id, #2: xpos, #3: ypos, #4: width of note,
                            %%% #5: height of note, #6: depth of note, #7: page
   \@ifundefined{@ND@#1}%
      {\@tempcnta\@ND@max \advance\@tempcnta\@ne
       \ifnum\@tempcnta=#1\relax
          \global\@ND@max\@tempcnta
       \else
          \ifnum\@ND@max<\z@\else
             \xdef\@ND@idlist{\@ND@idlist\@ND@elt{\the\@ND@min}{\the\@ND@max}}%
          \fi
          \global\@ND@min=#1\relax
          \global\@ND@max\@ND@min
       \fi}%
      {\gdef\@multiplelabels{\@latex@warning@no@line{There were multiply-defined labels}}%
       \@latex@warning@no@line%%% 
          {Note ID `#1' multiply appeared}}%
   \global\@namedef{@ND@#1}{{#2}{#3}{#4}{#5}{#6}{#7}}}
\def\@notedata#1#2#3#4#5#6#7{%
   \def\@tempa{{#2}{#3}{#4}{#5}{#6}{#7}}%
   \expandafter\ifx\csname @ND@#1\endcsname\@tempa\else \@tempswatrue \fi}
\def\checknotedata{%
 \ifnum\@ND@max<\z@\else
   \xdef\@ND@idlist{\@ND@idlist\@ND@elt{\the\@ND@min}{\the\@ND@max}}%
   \begingroup
   \let\@ND@elt\@checknotedata
   \@ND@idlist
   \endgroup
 \fi}
\def\@checknotedata#1#2{%
   \def\@currpage{-10000}%
   \@tempcnta\z@  \@tempcntb\z@
   \@tempdima-\p@ \@tempdimb-\p@
   \let\@linelist\@empty
   \let\@elt@udnote\relax
   \count@#1\relax \advance\count@\m@ne
   \@whilenum\count@<#2\do{%
      \advance\count@\@ne
      \@checknotedata@split\count@
      \def\@tempz{T}%
      \ifnum\@currpage=\@thispage\relax
         \ifdim\@thisy sp<\@tempdima \def\@tempz{F}\fi
         \ifdim\@thisy sp>\@tempdimb \def\@tempz{F}\fi
      \else
         \def\@tempz{F}%
      \fi
      \if T\@tempz\relax
         \@tempcntb\count@
      \else
         \ifnum\@tempcnta>\z@
            \edef\@linelist{\@linelist\@elt@udnote{\the\@tempcnta}{\the\@tempcntb}}%
         \fi
         \@tempcnta\count@ \@tempcntb\count@
         \let\@currpage\@thispage
         \@tempdima\@thisy sp\relax
         \@tempdimb\@tempdima
         \advance\@tempdima -\@ND@yfuzz\relax
         \advance\@tempdimb  \@ND@yfuzz\relax
      \fi}%
   \edef\@linelist{\@linelist\@elt@udnote{\the\@tempcnta}{\the\@tempcntb}}%
   \let\@elt@udnote\@checknotedata@elt
   \@linelist}
\def\@ND@yfuzz{3\p@}
\def\@checknotedata@split#1{%
   \expandafter\expandafter\expandafter\@checknotedata@split@
      \csname @ND@\number#1\endcsname 000000\@nnil}
\def\@checknotedata@split@#1#2#3#4#5#6#7\@nnil{%
   \def\@thisx{#1}%
   \def\@thisy{#2}%
   \def\@thiswd{#3}%
   \def\@thisht{#4}%
   \def\@thisdp{#5}%
   \def\@thispage{#6}}
\def\@checknotedata@elt#1#2{%
   \count@#2\relax \advance\count@\@ne
   \@whilenum\count@>#1\do{%
      \advance\count@\m@ne
      \@checknotedata@split\count@
      \dimen@\@thisx sp\relax
      \advance\dimen@ \@thiswd sp\relax
      \advance\dimen@\noterulehsize\relax
      \advance\dimen@\p@
      \let\@currht\@thisht
      \@tempcntb\@ne
      \@tempcnta\count@
      \@whilenum\@tempcnta<#2\do{%
         \advance\@tempcnta\@ne
         \@checknotedata@split\@tempcnta
         \ifdim\@thisx sp<\dimen@
            \@tempdima\noteshift\relax
            \@tempdimb\@thisdp sp\relax
            \advance\@tempdimb\@currht sp\relax
            \advance\@tempdimb\lineskip
            \divide\@tempdimb\@tempdima
            \count\tw@\@tempdimb
            \advance\count\tw@ \@ne
            \advance\count\tw@\@nameuse{@NDS@\the\@tempcnta}\relax
            \ifnum\@tempcntb<\count\tw@ \@tempcntb\count\tw@ \fi
         \fi}%
      \expandafter\xdef\csname @NDS@\the\count@\endcsname{\the\@tempcntb}}}
\AtEndDocument{%
   \if@filesw
      \write\@auxout{\string\checknotedata}%
      \let\checknotedata\relax
      \def\notedata{\@notedata}%
   \fi}

\endinput